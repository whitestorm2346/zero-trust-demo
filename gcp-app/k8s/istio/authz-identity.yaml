# istio-system 還是放行，避免你又不小心把控制面鎖住
apiVersion: security.istio.io/v1
kind: AuthorizationPolicy
metadata:
  name: allow-istio-system-all
  namespace: istio-system
spec:
  action: ALLOW
  rules:
    - {}
---
# default 裡的 service-b 授權
apiVersion: security.istio.io/v1
kind: AuthorizationPolicy
metadata:
  name: service-b-authz
  namespace: default
spec:
  selector:
    matchLabels:
      app: service-b
  action: ALLOW
  rules:
    # ① 給 ingress gateway 打 /public
    - from:
        - source:
            principals:
              - "spiffe://cluster.local/ns/istio-system/sa/istio-ingressgateway-service-account"
      to:
        - operation:
            paths: ["/public"]
    # ② 給 default namespace 裡面的 pod 打 /private
    #    這裡先放 service-a + default，讓你現在測得動
    - from:
        - source:
            principals:
              - "spiffe://cluster.local/ns/default/sa/service-a"
              - "spiffe://cluster.local/ns/default/sa/default"
      to:
        - operation:
            paths: ["/private"]
