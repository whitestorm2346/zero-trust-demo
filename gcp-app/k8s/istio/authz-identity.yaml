# gcp-app/k8s/istio/authz-identity.yaml

# 1) /public 開放
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: b-allow-public
  namespace: default
spec:
  selector:
    matchLabels:
      app: service-b
  action: ALLOW
  rules:
  - to:
    - operation:
        methods: ["GET"]
        paths: ["/public"]

---
# 2) /private 只給 service-a 這個 SA
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: b-allow-private-from-service-a
  namespace: default
spec:
  selector:
    matchLabels:
      app: service-b
  action: ALLOW
  rules:
  - from:
    - source:
        principals: ["cluster.local/ns/default/sa/service-a"]
    to:
    - operation:
        methods: ["GET"]
        paths: ["/private"]

---
# 3) 其他一律拒絕
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: b-deny-all-others
  namespace: default
spec:
  selector:
    matchLabels:
      app: service-b
  action: DENY
  rules:
  - to:
    - operation:
        methods: ["*"]
        paths: ["*"]
