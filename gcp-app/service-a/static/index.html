<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Zero Trust Demo</title>
  </head>
  <body>
    <h2>Zero Trust Demo (JWT)</h2>

    <h3>KeyCloak Login</h3>
    <button onclick="login()">Login</button>
    <p id="loginStatus"></p>

    <hr />

    <h3>Actions</h3>
    <button onclick="callPublic()">Call Public</button>
    <button onclick="callPrivate()">Call Private</button>

    <pre id="result"></pre>

    <script>
      let token = null;

      const KEYCLOAK_BASE = "http://localhost:18080";
      const REALM = "istio-demo";
      const CLIENT_ID = "istio-client";

      function login() {
        const redirectUri = window.location.origin;
        console.log("localhost keycloak login");

        const authUrl =
          `${KEYCLOAK_BASE}/realms/${REALM}/protocol/openid-connect/auth` +
          `?client_id=${CLIENT_ID}` +
          `&response_type=token` +
          `&scope=openid` +
          `&redirect_uri=${encodeURIComponent(redirectUri)}`;

        window.location.href = authUrl;
      }

      function parseTokenFromUrl() {
        if (!window.location.hash) return null;

        const params = new URLSearchParams(window.location.hash.substring(1));
        return params.get("access_token");
      }

      window.onload = () => {
        token = parseTokenFromUrl();
        if (token) {
          document.getElementById("loginStatus").innerText =
            "Logged in via Keycloak";
          // 清掉 URL fragment，比較乾淨
          history.replaceState({}, document.title, window.location.pathname);
        }
      };

      async function callPublic() {
        const resp = await fetch("/public");
        document.getElementById("result").innerText = await resp.text();
      }

      async function callPrivate() {
        console.log("TOKEN =", token);

        if (!token) {
          alert("Please login first");
          return;
        }

        const resp = await fetch("/private", {
          headers: {
            Authorization: "Bearer " + token,
          },
        });

        document.getElementById("result").innerText = await resp.text();
      }
    </script>
  </body>
</html>
